begin_unit|revision:1.0.0;language:Java;cregit-version:0.0.1
begin_comment
comment|/*****************************************************************  *   Licensed to the Apache Software Foundation (ASF) under one  *  or more contributor license agreements.  See the NOTICE file  *  distributed with this work for additional information  *  regarding copyright ownership.  The ASF licenses this file  *  to you under the Apache License, Version 2.0 (the  *  "License"); you may not use this file except in compliance  *  with the License.  You may obtain a copy of the License at  *  *    http://www.apache.org/licenses/LICENSE-2.0  *  *  Unless required by applicable law or agreed to in writing,  *  software distributed under the License is distributed on an  *  "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY  *  KIND, either express or implied.  See the License for the  *  specific language governing permissions and limitations  *  under the License.  ****************************************************************/
end_comment

begin_package
package|package
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|modeler
operator|.
name|dialog
operator|.
name|db
operator|.
name|load
package|;
end_package

begin_import
import|import
name|java
operator|.
name|io
operator|.
name|File
import|;
end_import

begin_import
import|import
name|java
operator|.
name|sql
operator|.
name|Connection
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|swing
operator|.
name|JOptionPane
import|;
end_import

begin_import
import|import
name|javax
operator|.
name|swing
operator|.
name|SwingUtilities
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|configuration
operator|.
name|ConfigurationNode
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|configuration
operator|.
name|xml
operator|.
name|DataChannelMetaData
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|dbsync
operator|.
name|naming
operator|.
name|NameBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|dbsync
operator|.
name|reverse
operator|.
name|dbimport
operator|.
name|DbImportConfiguration
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|dbsync
operator|.
name|reverse
operator|.
name|dbimport
operator|.
name|ReverseEngineering
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|dbsync
operator|.
name|reverse
operator|.
name|dbload
operator|.
name|DbLoaderDelegate
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|dbsync
operator|.
name|reverse
operator|.
name|filters
operator|.
name|FiltersConfigBuilder
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|map
operator|.
name|DataMap
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|modeler
operator|.
name|Application
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|modeler
operator|.
name|ProjectController
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|modeler
operator|.
name|editor
operator|.
name|DbImportView
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|modeler
operator|.
name|pref
operator|.
name|DBConnectionInfo
import|;
end_import

begin_import
import|import
name|org
operator|.
name|apache
operator|.
name|cayenne
operator|.
name|util
operator|.
name|Util
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|Logger
import|;
end_import

begin_import
import|import
name|org
operator|.
name|slf4j
operator|.
name|LoggerFactory
import|;
end_import

begin_comment
comment|/**  * @since 4.0  */
end_comment

begin_class
specifier|public
class|class
name|DbLoaderContext
block|{
specifier|private
specifier|static
name|Logger
name|LOGGER
init|=
name|LoggerFactory
operator|.
name|getLogger
argument_list|(
name|DbLoaderContext
operator|.
name|class
argument_list|)
decl_stmt|;
specifier|private
name|DbImportConfiguration
name|config
decl_stmt|;
specifier|private
name|Connection
name|connection
decl_stmt|;
specifier|private
name|ProjectController
name|projectController
decl_stmt|;
specifier|private
name|boolean
name|existingMap
decl_stmt|;
specifier|private
name|DataMap
name|dataMap
decl_stmt|;
specifier|private
name|boolean
name|stopping
decl_stmt|;
specifier|private
name|String
name|loadStatusNote
decl_stmt|;
specifier|private
name|DataChannelMetaData
name|metaData
decl_stmt|;
specifier|public
name|DbLoaderContext
parameter_list|(
name|DataChannelMetaData
name|metaData
parameter_list|)
block|{
name|this
operator|.
name|metaData
operator|=
name|metaData
expr_stmt|;
block|}
name|DataMap
name|getDataMap
parameter_list|()
block|{
return|return
name|dataMap
return|;
block|}
name|boolean
name|isExistingDataMap
parameter_list|()
block|{
return|return
name|existingMap
return|;
block|}
specifier|public
name|void
name|setProjectController
parameter_list|(
name|ProjectController
name|projectController
parameter_list|)
block|{
name|this
operator|.
name|projectController
operator|=
name|projectController
expr_stmt|;
block|}
name|ProjectController
name|getProjectController
parameter_list|()
block|{
return|return
name|projectController
return|;
block|}
name|void
name|setConfig
parameter_list|(
name|DbImportConfiguration
name|config
parameter_list|)
block|{
name|this
operator|.
name|config
operator|=
name|config
expr_stmt|;
block|}
name|DbImportConfiguration
name|getConfig
parameter_list|()
block|{
return|return
name|config
return|;
block|}
specifier|public
name|void
name|setConnection
parameter_list|(
name|Connection
name|connection
parameter_list|)
block|{
name|this
operator|.
name|connection
operator|=
name|connection
expr_stmt|;
block|}
specifier|public
name|Connection
name|getConnection
parameter_list|()
block|{
return|return
name|connection
return|;
block|}
specifier|public
name|boolean
name|isStopping
parameter_list|()
block|{
return|return
name|stopping
return|;
block|}
specifier|public
name|DataChannelMetaData
name|getMetaData
parameter_list|()
block|{
return|return
name|metaData
return|;
block|}
name|void
name|setStopping
parameter_list|(
name|boolean
name|stopping
parameter_list|)
block|{
name|this
operator|.
name|stopping
operator|=
name|stopping
expr_stmt|;
block|}
name|String
name|getStatusNote
parameter_list|()
block|{
return|return
name|loadStatusNote
return|;
block|}
name|void
name|setStatusNote
parameter_list|(
name|String
name|loadStatusNote
parameter_list|)
block|{
name|this
operator|.
name|loadStatusNote
operator|=
name|loadStatusNote
expr_stmt|;
block|}
specifier|private
name|void
name|fillReverseEngineeringFromView
parameter_list|(
name|ReverseEngineering
name|reverseEngineering
parameter_list|,
name|DbImportView
name|view
parameter_list|)
block|{
name|reverseEngineering
operator|.
name|setUsePrimitives
argument_list|(
name|view
operator|.
name|isUsePrimitives
argument_list|()
argument_list|)
expr_stmt|;
name|reverseEngineering
operator|.
name|setUseJava7Types
argument_list|(
name|view
operator|.
name|isUseJava7Typed
argument_list|()
argument_list|)
expr_stmt|;
name|reverseEngineering
operator|.
name|setForceDataMapCatalog
argument_list|(
name|view
operator|.
name|isForceDataMapCatalog
argument_list|()
argument_list|)
expr_stmt|;
name|reverseEngineering
operator|.
name|setForceDataMapSchema
argument_list|(
name|view
operator|.
name|isForceDataMapSchema
argument_list|()
argument_list|)
expr_stmt|;
name|reverseEngineering
operator|.
name|setSkipRelationshipsLoading
argument_list|(
name|view
operator|.
name|isSkipRelationshipsLoading
argument_list|()
argument_list|)
expr_stmt|;
name|reverseEngineering
operator|.
name|setSkipPrimaryKeyLoading
argument_list|(
name|view
operator|.
name|isSkipPrimaryKeyLoading
argument_list|()
argument_list|)
expr_stmt|;
name|reverseEngineering
operator|.
name|setMeaningfulPkTables
argument_list|(
name|view
operator|.
name|getMeaningfulPk
argument_list|()
argument_list|)
expr_stmt|;
name|reverseEngineering
operator|.
name|setNamingStrategy
argument_list|(
name|view
operator|.
name|getNamingStrategy
argument_list|()
argument_list|)
expr_stmt|;
name|reverseEngineering
operator|.
name|setStripFromTableNames
argument_list|(
name|view
operator|.
name|getStripFromTableNames
argument_list|()
argument_list|)
expr_stmt|;
block|}
specifier|public
name|boolean
name|buildConfig
parameter_list|(
name|DBConnectionInfo
name|connectionInfo
parameter_list|,
name|DbImportView
name|view
parameter_list|)
block|{
if|if
condition|(
name|connectionInfo
operator|==
literal|null
condition|)
block|{
return|return
literal|false
return|;
block|}
comment|// Build reverse engineering from metadata and dialog values
name|ReverseEngineering
name|metaReverseEngineering
init|=
name|metaData
operator|.
name|get
argument_list|(
name|getProjectController
argument_list|()
operator|.
name|getCurrentDataMap
argument_list|()
argument_list|,
name|ReverseEngineering
operator|.
name|class
argument_list|)
decl_stmt|;
name|fillReverseEngineeringFromView
argument_list|(
name|metaReverseEngineering
argument_list|,
name|view
argument_list|)
expr_stmt|;
comment|// Create copy of metaReverseEngineering
name|ReverseEngineering
name|reverseEngineering
init|=
operator|new
name|ReverseEngineering
argument_list|(
name|metaReverseEngineering
argument_list|)
decl_stmt|;
name|DbImportConfiguration
name|config
init|=
operator|new
name|DbImportConfiguration
argument_list|()
block|{
annotation|@
name|Override
specifier|public
name|DbLoaderDelegate
name|createLoaderDelegate
parameter_list|()
block|{
return|return
operator|new
name|LoaderDelegate
argument_list|(
name|DbLoaderContext
operator|.
name|this
argument_list|)
return|;
block|}
block|}
decl_stmt|;
name|fillConfig
argument_list|(
name|config
argument_list|,
name|connectionInfo
argument_list|,
name|reverseEngineering
argument_list|)
expr_stmt|;
name|setConfig
argument_list|(
name|config
argument_list|)
expr_stmt|;
name|prepareDataMap
argument_list|()
expr_stmt|;
return|return
literal|true
return|;
block|}
comment|// Fill config from metadata reverseEngineering
specifier|private
name|void
name|fillConfig
parameter_list|(
name|DbImportConfiguration
name|config
parameter_list|,
name|DBConnectionInfo
name|connectionInfo
parameter_list|,
name|ReverseEngineering
name|reverseEngineering
parameter_list|)
block|{
name|FiltersConfigBuilder
name|filtersConfigBuilder
init|=
operator|new
name|FiltersConfigBuilder
argument_list|(
name|reverseEngineering
argument_list|)
decl_stmt|;
name|config
operator|.
name|setAdapter
argument_list|(
name|connectionInfo
operator|.
name|getDbAdapter
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setUsername
argument_list|(
name|connectionInfo
operator|.
name|getUserName
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setPassword
argument_list|(
name|connectionInfo
operator|.
name|getPassword
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setDriver
argument_list|(
name|connectionInfo
operator|.
name|getJdbcDriver
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setUrl
argument_list|(
name|connectionInfo
operator|.
name|getUrl
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|getDbLoaderConfig
argument_list|()
operator|.
name|setFiltersConfig
argument_list|(
name|filtersConfigBuilder
operator|.
name|build
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setMeaningfulPkTables
argument_list|(
name|reverseEngineering
operator|.
name|getMeaningfulPkTables
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setNamingStrategy
argument_list|(
name|reverseEngineering
operator|.
name|getNamingStrategy
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setDefaultPackage
argument_list|(
name|reverseEngineering
operator|.
name|getDefaultPackage
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setStripFromTableNames
argument_list|(
name|reverseEngineering
operator|.
name|getStripFromTableNames
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setUsePrimitives
argument_list|(
name|reverseEngineering
operator|.
name|isUsePrimitives
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setUseJava7Types
argument_list|(
name|reverseEngineering
operator|.
name|isUseJava7Types
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setForceDataMapCatalog
argument_list|(
name|reverseEngineering
operator|.
name|isForceDataMapCatalog
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setForceDataMapSchema
argument_list|(
name|reverseEngineering
operator|.
name|isForceDataMapSchema
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setSkipRelationshipsLoading
argument_list|(
name|reverseEngineering
operator|.
name|getSkipRelationshipsLoading
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setSkipPrimaryKeyLoading
argument_list|(
name|reverseEngineering
operator|.
name|getSkipPrimaryKeyLoading
argument_list|()
argument_list|)
expr_stmt|;
name|config
operator|.
name|setTableTypes
argument_list|(
operator|new
name|String
index|[]
block|{
literal|"TABLE"
block|,
literal|"VIEW"
block|,
literal|"SYSTEM TABLE"
block|}
argument_list|)
expr_stmt|;
block|}
specifier|private
name|void
name|prepareDataMap
parameter_list|()
block|{
name|dataMap
operator|=
name|getProjectController
argument_list|()
operator|.
name|getCurrentDataMap
argument_list|()
expr_stmt|;
name|existingMap
operator|=
name|dataMap
operator|!=
literal|null
expr_stmt|;
if|if
condition|(
operator|!
name|existingMap
condition|)
block|{
name|ConfigurationNode
name|root
init|=
name|getProjectController
argument_list|()
operator|.
name|getProject
argument_list|()
operator|.
name|getRootNode
argument_list|()
decl_stmt|;
name|dataMap
operator|=
operator|new
name|DataMap
argument_list|()
expr_stmt|;
name|dataMap
operator|.
name|setName
argument_list|(
name|NameBuilder
operator|.
name|builder
argument_list|(
name|dataMap
argument_list|,
name|root
argument_list|)
operator|.
name|name
argument_list|()
argument_list|)
expr_stmt|;
block|}
if|if
condition|(
name|dataMap
operator|.
name|getConfigurationSource
argument_list|()
operator|!=
literal|null
condition|)
block|{
name|getConfig
argument_list|()
operator|.
name|setTargetDataMap
argument_list|(
operator|new
name|File
argument_list|(
name|dataMap
operator|.
name|getConfigurationSource
argument_list|()
operator|.
name|getURL
argument_list|()
operator|.
name|getPath
argument_list|()
argument_list|)
argument_list|)
expr_stmt|;
block|}
block|}
specifier|public
name|void
name|processWarn
parameter_list|(
specifier|final
name|Throwable
name|th
parameter_list|,
specifier|final
name|String
name|message
parameter_list|)
block|{
name|LOGGER
operator|.
name|warn
argument_list|(
name|message
argument_list|,
name|Util
operator|.
name|unwindException
argument_list|(
name|th
argument_list|)
argument_list|)
expr_stmt|;
block|}
specifier|public
name|void
name|processException
parameter_list|(
specifier|final
name|Throwable
name|th
parameter_list|,
specifier|final
name|String
name|message
parameter_list|)
block|{
name|LOGGER
operator|.
name|info
argument_list|(
literal|"Exception on reverse engineering"
argument_list|,
name|Util
operator|.
name|unwindException
argument_list|(
name|th
argument_list|)
argument_list|)
expr_stmt|;
name|SwingUtilities
operator|.
name|invokeLater
argument_list|(
operator|new
name|Runnable
argument_list|()
block|{
specifier|public
name|void
name|run
parameter_list|()
block|{
name|JOptionPane
operator|.
name|showMessageDialog
argument_list|(
name|Application
operator|.
name|getFrame
argument_list|()
argument_list|,
name|th
operator|.
name|getMessage
argument_list|()
argument_list|,
name|message
argument_list|,
name|JOptionPane
operator|.
name|ERROR_MESSAGE
argument_list|)
expr_stmt|;
block|}
block|}
argument_list|)
expr_stmt|;
block|}
block|}
end_class

end_unit

