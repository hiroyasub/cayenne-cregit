<!--
   Licensed to the Apache Software Foundation (ASF) under one
   or more contributor license agreements.  See the NOTICE file
   distributed with this work for additional information
   regarding copyright ownership.  The ASF licenses this file
   to you under the Apache License, Version 2.0 (the
   "License"); you may not use this file except in compliance
   with the License.  You may obtain a copy of the License at
 
     http://www.apache.org/licenses/LICENSE-2.0
 
   Unless required by applicable law or agreed to in writing,
   software distributed under the License is distributed on an
   "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
   KIND, either express or implied.  See the License for the
   specific language governing permissions and limitations
   under the License.
-->
<html>
  <head>
    <title>Apache Cayenne Documentation - Lifecycle Callbacks</title>
    <style type="text/css">@import "../../../style.css";</style>
  </head>
<body>
  <div class="header">
    <div style="float: left;"><a href="http://incubator.apache.org/cayenne/"><img src="../../../images/logo.gif" align="absmiddle" border="0"></a></div>
    <span class="logoSpaceLink"><a href="../../../index.html">Cayenne User Documentation</a></span><br />
    <span class="pagetitle">Lifecycle Callbacks</span>
  </div>
<div id="cayenne_toc">
<ul>
<li><a href="../../../Documentation/User Guide/Introduction/index.html">Introduction</a></li>
<li><a href="../../../Documentation/User Guide/Installation/index.html">Installation</a></li>
<li><a href="../../../Documentation/User Guide/Quick Start/index.html">Quick Start</a></li>
<li><a href="../../../Documentation/User Guide/Design/index.html">Design</a></li>
<li><a href="../../../Documentation/User Guide/DataContext/index.html">DataContext</a></li>
<li><a href="../../../Documentation/User Guide/Queries/index.html">Queries</a></li>
<li><a href="../../../Documentation/User Guide/DataObjects/index.html">DataObjects</a></li>
<li><a href="../../../Documentation/User Guide/Stored Procedures/index.html">Stored Procedures</a></li>
<li><a href="../../../Documentation/User Guide/Expressions/index.html">Expressions</a></li>
<li><a href="../../../Documentation/User Guide/Lifecycle Callbacks/index.html">Lifecycle Callbacks</a><ul>
</ul>
</li>
<li><a href="../../../Documentation/User Guide/Performance Tuning/index.html">Performance Tuning</a></li>
<li><a href="../../../Documentation/User Guide/Caching and Fresh Data/index.html">Caching and Fresh Data</a></li>
<li><a href="../../../Documentation/User Guide/Deployment/index.html">Deployment</a></li>
<li><a href="../../../Documentation/User Guide/Ant Tasks/index.html">Ant Tasks</a></li>
<li><a href="../../../Documentation/User Guide/Maven2 Plugins/index.html">Maven2 Plugins</a></li>
<li><a href="../../../Documentation/User Guide/Customizing/index.html">Customizing</a></li>
<li><a href="../../../Documentation/User Guide/DataViews/index.html">DataViews</a></li>
</ul>
</div>
<div id="ConfluenceContent"><p><em>(in 3.0 since 9/21/2006)</em></p>

<p><em>TODO: annotations, default callback for all entities, Modeler support</em></p>

<p>Users can register callback methods that will be invoked during the lifecycle of persistent objects. Callback mechanism matches closely the one defined in the <a href="../../../Documentation/JPA Guide/index.html" title="JPA Guide">JPA Specification</a> (except that it works with JDK 1.4 and allows preconfigured listeners). There are seven lifecycle callbacks described below (PrePersist, PostPersist, PreUpdate, PostUpdate, PreRemove, PostRemove, PostLoad). There are two types of invocations for each one of them: <b>callback on a persistent object</b> itself or a <b>callback on  an arbitrary listener object</b>.</p>

<table cellpadding='5' width='85%' cellspacing='8px' class='noteMacro' border="0" align='center'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="../../../images/emoticons/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td><b class="strong">Callbacks feature supercedes the following 1.2/2.0 features:</b><br />
<ul>
	<li>Interception of object state transitions inside <tt>"Persistent.setPersistenceState()"</tt>.</li>
	<li>Event mechanism defined in <tt>"org.apache.cayenne.access.event"</tt> package. Scheduled for removal in 3.0.</li>
	<li><tt>"DataObject.validateForX"</tt> - it is a good idea to use it strictly for validation; updating the state before commit should be done via callbacks.</li>
	<li><tt>"DataObject.fetchFinished()"</tt> - scheduled for removal in 3.0</li>
</ul>
</td></tr></table>

<h2><a name="LifecycleCallbacks-CallbackMethodSemantics"></a>Callback Method Semantics</h2>

<ul>
	<li>No formal interface is required to mark a method to be used for callback.</li>
	<li>A callback method signature looks like <tt>"void someMethod()"</tt> for persistent classes.</li>
	<li>It looks like <tt>"void method(Type entityObject)"</tt> for listener classes.</li>
	<li>A callback method can have an arbitrary name.</li>
	<li>A callback method can use public, private, protected or default access.</li>
	<li>They must NOT be static.</li>
	<li>Callback methods are polymorphic - registering a callback on a superclass (even if the superclass does not map to an entity) will ensure the callback will be invoked on all entity subclasses, using the overriding subclass method if applicable.</li>
</ul>


<p>Callback on persistent object example:</p>

<div class="code"><div class="codeContent">
<pre class="code-java"><span class="code-keyword">public</span> class Artist { 
   ...

   <span class="code-comment">// a vaid callback method
</span>   <span class="code-keyword">protected</span> void setDefaultProperties() {
      ...
   }
}</pre>
</div></div>


<p>Callback on a listener class example:</p>

<div class="code"><div class="codeContent">
<pre class="code-java"><span class="code-keyword">public</span> class MyListener { 
   ...

   <span class="code-comment">// a valid callback method
</span>   <span class="code-keyword">public</span> void initArtist(Artist a) {
      ...
   }
}</pre>
</div></div>

<h2><a name="LifecycleCallbacks-TypesofCallbacks"></a>Types of Callbacks</h2>

<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'>Callback</th>
<th class='confluenceTh'>Invoked...</th>
</tr>
<tr>
<td class='confluenceTd'>PrePersist</td>
<td class='confluenceTd'>Within <tt>"ObjectContext.newObject()"</tt> after ObjectId and ObjectContext are set.</td>
</tr>
<tr>
<td class='confluenceTd'>PreRemove</td>
<td class='confluenceTd'>Before an object is deleted inside <tt>"ObjectContext.deleteObject()"</tt>; also includes all objects that will be deleted as a result of CASCADE delete rule.</td>
</tr>
<tr>
<td class='confluenceTd'>PreUpdate</td>
<td class='confluenceTd'>Prior to commit (and prior to "validateFor*") within <tt>"ObjectContext.commitChanges()"</tt> and <tt>"ObjectContext.commitChangesToParent()"</tt></td>
</tr>
<tr>
<td class='confluenceTd'>PostPersist</td>
<td class='confluenceTd'>Within <tt>"ObjectContext.commitChanges()"</tt>, after commit of a new object is done.</td>
</tr>
<tr>
<td class='confluenceTd'>PostRemove</td>
<td class='confluenceTd'>Within <tt>"ObjectContext.commitChanges()"</tt>, after commit of a deleted object is done.</td>
</tr>
<tr>
<td class='confluenceTd'>PostUpdate</td>
<td class='confluenceTd'>Within <tt>"ObjectContext.commitChanges()"</tt>, after commit of a modified object is done.</td>
</tr>
<tr>
<td class='confluenceTd'>PostLoad</td>
<td class='confluenceTd'><ul>
	<li>Within <tt>"ObjectContext.performQuery()"</tt> after the object is fetched.</li>
	<li>Within <tt>"ObjectContext.rollbackChanges()"</tt> after the object is reverted.</li>
	<li>Anytime a faulted object is resolved (i.e. if a relationship is fetched.</li>
</ul>
</td>
</tr>
</tbody></table>

<h2><a name="LifecycleCallbacks-EnablingCallbacks"></a>Enabling Callbacks</h2>

<p><em>TODO: expect this to be changed to something more user-friendly.</em></p>

<p>Registering listener:</p>

<div class="code"><div class="codeContent">
<pre class="code-java">DataDomain domain = ...
<span class="code-object">int</span> callbackType = LifecycleEventCallback.PRE_PERSIST; <span class="code-comment">// choose callback type you care about
</span>domain.getEntityResolver().getCallbacks(callbackType).addListener(
				MyEntity.class, <span class="code-keyword">new</span> MyListener(), <span class="code-quote">"callbackMethod"</span>);</pre>
</div></div> 

<p>Building ObjectContext with enabled callbacks:</p>
<div class="code"><div class="codeContent">
<pre class="code-java">DataChannelCallbackInterceptor postInterceptor = <span class="code-keyword">new</span> DataChannelCallbackInterceptor();
postInterceptor.setChannel(domain);
ObjectStore objectStore = <span class="code-keyword">new</span> ObjectStore(domain.getSharedSnapshotCache());

ObjectContextCallbackInterceptor preInterceptor = <span class="code-keyword">new</span> ObjectContextCallbackInterceptor();
preInterceptor.setContext(<span class="code-keyword">new</span> DataContext(postInterceptor, objectStore));

ObjectContext userContext = preInterceptor;</pre>
</div></div></div>
</div>
  <div class="clearer">.</div>
  <div style="height: 12px; background-image: url('../../../images/border_bottom.gif'); background-repeat: repeat-x;"></div>

  <div class="smalltext copyright">
    Copyright &copy;2001-2006 Apache Software Foundation
  </div>

</body>
</html>
